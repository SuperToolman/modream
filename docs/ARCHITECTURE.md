# 架构设计说明

## 📐 项目结构

```
modream/
├── crates/              # Rust 后端代码（DDD 分层架构）
│   ├── domain/          # 领域层：核心业务模型
│   ├── application/     # 应用层：业务逻辑编排
│   ├── infrastructure/  # 基础设施层：数据库、文件系统
│   ├── interfaces/      # 接口层：HTTP API、WebSocket
│   ├── shared/          # 共享层：日志、配置、工具
│   └── desktop/         # 桌面启动器：Tauri 集成
├── web/                 # 前端代码（Next.js）
├── docs/                # 项目文档
└── scripts/             # 开发脚本
```

---

## 🎯 设计理念

### 1. 前后端完全解耦

**传统 Tauri 项目的问题**：
```
project/
├── src-tauri/    # Rust 代码
├── src/          # 前端代码
└── package.json  # 前后端混在一起
```

- ❌ 前后端代码混在一起
- ❌ 无法单独部署后端 API
- ❌ 无法灵活切换启动模式
- ❌ 团队协作困难

**我们的设计**：
```
modream/
├── crates/       # 后端独立
└── web/          # 前端独立
```

- ✅ 前后端完全解耦
- ✅ 可以单独部署 API 服务器
- ✅ 灵活的启动模式（桌面/服务器/GUI）
- ✅ 团队协作友好

---

### 2. DDD 分层架构

采用领域驱动设计（Domain-Driven Design）的分层架构：

```
┌─────────────────────────────────────┐
│         interfaces (接口层)          │  ← HTTP API、WebSocket
├─────────────────────────────────────┤
│       application (应用层)           │  ← 业务逻辑编排
├─────────────────────────────────────┤
│         domain (领域层)              │  ← 核心业务模型
├─────────────────────────────────────┤
│    infrastructure (基础设施层)       │  ← 数据库、文件系统
└─────────────────────────────────────┘
           ↑
       shared (共享层)  ← 日志、配置、工具
```

**优势**：
- ✅ 清晰的职责分离
- ✅ 易于测试和维护
- ✅ 业务逻辑与技术实现解耦
- ✅ 符合 SOLID 原则

---

### 3. 灵活的启动模式

#### 模式 1：桌面模式（默认）
```bash
cargo run --bin desktop
```
- 自动启动 WebAPI（8080 端口）
- 自动打开 Tauri 桌面窗口
- 适合最终用户

#### 模式 2：服务器模式
```bash
cargo run --bin desktop -- --server
```
- 只启动 WebAPI（8080 端口）
- 不启动桌面窗口
- 适合 Linux 服务器、Docker 部署

#### 模式 3：GUI 模式
```bash
cargo run --bin desktop -- --gui
```
- 只启动 Tauri 桌面窗口
- 连接到已运行的 API（本地或远程）
- 适合开发调试

#### 模式 4：开发模式
```bash
# 终端 1：启动 API
cargo run --bin desktop -- --server

# 终端 2：启动前端（热重载）
cd web && pnpm run dev
```
- 前端支持热重载
- 后端可以随时调试
- 适合日常开发

---

## 🚀 为什么不使用 `pnpm run tauri dev`？

### Tauri CLI 的限制

Tauri CLI 期望的项目结构：
```
project/
├── src-tauri/
│   └── tauri.conf.json
├── src/
└── package.json  ← 必须在同一层
```

我们的结构：
```
modream/
├── crates/desktop/
│   └── tauri.conf.json
└── web/
    └── package.json  ← 不在同一层
```

**Tauri CLI 无法识别这种结构**，因为它假设前后端紧密耦合。

### 我们的选择

**我们故意选择了前后端解耦的架构**，因为：

1. ✅ **更灵活**：可以单独部署 API、桌面应用、Web 应用
2. ✅ **更清晰**：前后端代码完全分离
3. ✅ **更强大**：支持多种启动模式
4. ✅ **更适合团队**：前后端开发者不会互相干扰

**代价**：
- ⚠️ 无法使用 `pnpm run tauri dev`（但我们有更好的方式）
- ⚠️ 开发时需要 2 个终端（但这很正常，大多数全栈项目都是这样）

---

## 📊 架构对比

| 特性 | 传统 Tauri 项目 | 我们的架构 |
|------|----------------|-----------|
| 前后端解耦 | ❌ | ✅ |
| DDD 分层 | ❌ | ✅ |
| 单独部署 API | ❌ | ✅ |
| 灵活启动模式 | ❌ | ✅ |
| 团队协作 | ⚠️ | ✅ |
| 一键启动 | ✅ | ✅（通过脚本）|
| Tauri CLI | ✅ | ❌ |

---

## 🎓 适用场景

### ✅ 适合我们的架构

- 需要同时提供桌面应用和 Web 应用
- 需要单独部署 API 服务器
- 团队有前后端分工
- 需要清晰的代码组织
- 需要灵活的部署方式

### ❌ 不适合我们的架构

- 只做简单的桌面应用（不需要 API）
- 前后端紧密耦合
- 不需要单独部署 API

---

## 🔄 未来扩展

我们的架构可以轻松扩展：

1. **移动端**：添加 `mobile/` 目录，复用 API
2. **微服务**：拆分 `crates/` 为多个服务
3. **多租户**：在 `domain/` 层添加租户隔离
4. **插件系统**：在 `application/` 层添加插件机制
5. **多语言客户端**：复用 API，添加其他语言的客户端

---

## 📚 相关文档

- [快速开始](../README.md#快速开始)
- [部署指南](./DEPLOYMENT_GUIDE.md)
- [开发指南](./DEVELOPMENT.md)（待补充）
- [API 文档](http://localhost:8080/swagger-ui)（启动后访问）

---

## 💡 总结

我们的架构设计**不是为了使用 Tauri CLI**，而是为了：

1. ✅ **清晰的代码组织**（DDD 分层）
2. ✅ **前后端解耦**（独立开发、部署）
3. ✅ **灵活的启动模式**（桌面/服务器/GUI）
4. ✅ **适合团队协作**（前后端分离）
5. ✅ **易于扩展**（移动端、微服务）

**这是一个深思熟虑的设计选择，不是妥协！**

